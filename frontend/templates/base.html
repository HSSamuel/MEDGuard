<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MedGuard</title>
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/favicon.ico.png') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Background image with dark overlay */
      body {
        position: relative;
        min-height: 100vh;
        margin: 0;
        font-family: Arial, sans-serif;
        background: url("{{ url_for('static', filename='images/medicals.jpg') }}")
          no-repeat center center fixed;
        background-size: cover;
        z-index: 0;
        color: #f5f5ff;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(2px);
        z-index: -1;
      }

      /* Panels and containers with frosted glass effect */
      .panel,
      .container,
      header,
      footer {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        color: #fff;
      }

      header.mg-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
      }

      .brand-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .brand p {
        margin: 2px 0;
        color: #ddd;
        font-style: italic;
      }

      footer.mg-footer {
        text-align: center;
        font-size: 0.85em;
        color: #eee;
        background: rgba(0, 0, 0, 0.4);
        padding: 10px;
        border-radius: 6px;
      }

      /* --- Chatbot Styles --- */
      #chat-toggle-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #2f4f4f;
        color: white;
        font-size: 24px;
        font-weight: bold;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }
      #chat-container {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 350px;
        max-width: 90vw;
        height: 500px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 1000;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
      }
      #chat-container.hidden {
        transform: scale(0);
        opacity: 0;
      }
      #chat-header {
        background: #2f4f4f;
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #chat-header h3 {
        margin: 0;
      }
      #chat-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }
      #chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        color: #333;
      }
      .chat-message {
        padding: 10px 15px;
        border-radius: 20px;
        max-width: 80%;
        white-space: pre-wrap;
      }
      .chat-message.user {
        background-color: #efefef;
        align-self: flex-end;
      }
      .chat-message.bot {
        background-color: #f0f8ff;
        align-self: flex-start;
        border: 1px solid #d6e9ff;
      }
      #chat-input-container {
        display: flex;
        padding: 10px;
        border-top: 1px solid #eee;
      }
      #chat-input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 20px;
        padding: 10px 15px;
        margin-right: 10px;
      }
      #chat-send-btn {
        background: #2f4f4f;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 10px 20px;
        cursor: pointer;
      }
      /* NEW: Styles for the quick reply buttons */
      .quick-replies-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px 15px 0 15px;
        justify-content: flex-end;
      }
      .quick-reply-btn {
        background-color: #e3f2fd;
        color: #0d47a1;
        border: 1px solid #bbdefb;
        border-radius: 20px;
        padding: 8px 15px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .quick-reply-btn:hover {
        background-color: #d0e8fc;
      }

      /* --- Navbar Styles --- */
      .navbar {
        background: rgba(0, 0, 0, 0.3);
        padding: 0 20px;
        border-radius: 8px;
        margin-top: -20px;
        position: relative;
      }
      .nav-list {
        display: flex;
        justify-content: space-between;
        align-items: center;
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .nav-left,
      .nav-right {
        display: flex;
        align-items: center;
      }

      .nav-item a,
      .nav-item .btn {
        color: white;
        text-decoration: none;
        padding: 15px 20px;
        display: block;
        transition: background 0.2s;
      }
      .nav-item a:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .nav-item .btn {
        padding: 8px 15px;
      }

      /* Hamburger Menu */
      .hamburger {
        display: none;
        cursor: pointer;
      }
      .hamburger div {
        width: 25px;
        height: 3px;
        background-color: white;
        margin: 5px 0;
      }

      @media (max-width: 960px) {
        .hamburger {
          display: block;
        }
        .nav-left,
        .nav-right {
          display: contents;
        }
        .nav-list {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          width: 100%;
          flex-direction: column;
          background: rgba(40, 60, 60, 0.95);
          backdrop-filter: blur(5px);
          padding: 10px 0;
          border-radius: 0 0 10px 10px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
          z-index: 100;
        }
        .nav-list.active {
          display: flex;
        }
        .nav-item {
          width: 100%;
          text-align: center;
        }
        .nav-item a,
        .nav-item .btn {
          width: 100%;
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <header class="mg-header">
      <div class="brand-container">
        <img
          src="{{ url_for('static', filename='images/logo.png') }}"
          alt="MedGuard Logo"
          style="height: 50px; border-radius: 8px"
        />
        <div class="brand">
          <p id="tagline" class="tagline"></p>
        </div>
      </div>
      <div class="hamburger">
        <div></div>
        <div></div>
        <div></div>
      </div>
    </header>

    <nav class="navbar container">
      <ul class="nav-list">
        <div class="nav-left">
          <li class="nav-item"><a href="{{ url_for('root') }}">Home</a></li>
          <li class="nav-item">
            <a href="{{ url_for('about_page') }}">About</a>
          </li>
          {% if session.user_id %}
          <li class="nav-item">
            <a href="{{ url_for('auth.my_reports') }}">My Reports</a>
          </li>
          {% endif %} {% if session.admin_id %}
          <li class="nav-item">
            <a href="{{ url_for('admin_api.admin_dashboard') }}">Dashboard</a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('admin_api.public_db_manager_page') }}"
              >Public DB Manager</a
            >
          </li>
          <li class="nav-item">
            <a href="{{ url_for('admin_api.hotspot_map_page') }}"
              >Hotspot Map</a
            >
          </li>
          {% endif %}
        </div>

        <div class="nav-right">
          {% if session.admin_id %}
          <li class="nav-item">
            <form
              action="{{ url_for('admin_logout') }}"
              method="post"
              style="margin: 0"
            >
              <input type="hidden" name="csrf" value="{{ session.csrf }}" />
              <button
                type="submit"
                class="btn"
                style="background: #dc3545; color: white; width: 100%"
              >
                Admin Logout
              </button>
            </form>
          </li>
          {% elif session.user_id %}
          <li class="nav-item">
            <span style="padding: 15px 20px; color: white"
              >Welcome, {{ session.user_name }}</span
            >
          </li>
          <li class="nav-item">
            <a
              href="{{ url_for('auth.logout') }}"
              class="btn"
              style="background-color: #dc3545"
              >Logout</a
            >
          </li>
          {% else %}
          <li class="nav-item">
            <a
              href="{{ url_for('auth.login') }}"
              class="btn"
              style="background-color: #360fd358"
              >User Login</a
            >
          </li>
          <li class="nav-item">
            <a
              href="{{ url_for('auth.register') }}"
              class="btn"
              style="background-color: #04700774"
              >Register</a
            >
          </li>
          {% endif %}
        </div>
      </ul>
    </nav>

    <main class="container">{% block content %}{% endblock %}</main>

    {% if session.admin_id %}
    <div
      id="confirm-modal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
      "
    >
      <div
        style="
          background: rgba(47, 79, 79, 0.9);
          padding: 25px;
          border-radius: 12px;
          max-width: 450px;
          width: 90%;
          text-align: center;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
          border-top: 4px solid #f39c12;
        "
      >
        <h3 id="confirm-modal-title" style="color: #92f394">Confirm Action</h3>
        <p id="confirm-modal-text" style="color: #ffffff"></p>
        <div
          style="
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
          "
        >
          <button id="confirm-modal-cancel-btn" class="btn btn-outline">
            Cancel
          </button>
          <button
            id="confirm-modal-confirm-btn"
            class="btn"
            style="background-color: #dc3545; color: white"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>
    {% endif %} {% if session.admin_id %}
    <div
      id="session-modal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      "
    >
      <div
        style="
          background: rgba(47, 79, 79, 0.9);
          padding: 25px;
          border-radius: 12px;
          max-width: 450px;
          width: 90%;
          text-align: center;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
          border-top: 4px solid #b45e19;
        "
      >
        <h3 style="color: #92f394">Session Timeout Warning</h3>
        <p style="color: #ffffff">
          Your session is about to expire due to inactivity. You will be logged
          out in
          <strong id="session-countdown" style="font-size: 1.2em">120</strong>
          seconds.
        </p>
        <div
          style="
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
          "
        >
          <button
            id="session-stay-btn"
            class="btn"
            style="background-color: #28a745; color: white"
          >
            Stay Logged In
          </button>
          <button
            id="session-logout-btn"
            class="btn"
            style="background-color: #dc3545; color: white"
          >
            Logout Now
          </button>
        </div>
      </div>
    </div>
    {% endif %}

    <footer class="mg-footer">
      <a
        href="{{ url_for('about_page') }}"
        style="color: #eee; text-decoration: none; margin-right: 15px"
        >About MedGuard</a
      >
      <small
        >© MedGuard — Fighting counterfeit medicine, one scan at a time.</small
      >
    </footer>

    <button id="chat-toggle-btn">?</button>
    <div id="chat-container" class="hidden">
      <div id="chat-header">
        <h3>MedGuard Assistant</h3>
        <button id="chat-close-btn">&times;</button>
      </div>
      <div id="chat-messages">
        <div class="chat-message bot">
          Hello! How can I help you today? You can ask me how to verify a drug,
          how to report a counterfeit, or what to do if you find one.
        </div>
      </div>
      <div id="chat-quick-replies" class="quick-replies-container"></div>
      <div id="chat-input-container">
        <input type="text" id="chat-input" placeholder="Ask a question..." />
        <button id="chat-send-btn">Send</button>
      </div>
    </div>

    {% block scripts %}{% endblock %}

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const hamburger = document.querySelector(".hamburger");
        const navList = document.querySelector(".nav-list");

        hamburger.addEventListener("click", () => {
          navList.classList.toggle("active");
        });
        const chatToggleBtn = document.getElementById("chat-toggle-btn");
        const chatContainer = document.getElementById("chat-container");
        const chatCloseBtn = document.getElementById("chat-close-btn");
        const chatSendBtn = document.getElementById("chat-send-btn");
        const chatInput = document.getElementById("chat-input");
        const chatMessages = document.getElementById("chat-messages");
        const quickRepliesContainer =
          document.getElementById("chat-quick-replies");

        const clearQuickReplies = () => {
          quickRepliesContainer.innerHTML = "";
        };

        const addMessage = (data, sender) => {
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("chat-message", sender);

          const textContainer = document.createElement("div");
          textContainer.innerHTML = data.answer;
          messageDiv.appendChild(textContainer);

          if (sender === "bot" && data.action) {
            const actionBtn = document.createElement("button");
            actionBtn.className = "btn btn-yellow chat-action-btn";
            actionBtn.textContent = data.action.buttonText;
            actionBtn.dataset.actionType = data.action.type;
            actionBtn.dataset.actionTarget = data.action.target;
            // NEW: Store prefill data as a JSON string
            if (data.action.prefill) {
              actionBtn.dataset.prefill = JSON.stringify(data.action.prefill);
            }
            actionBtn.style.marginTop = "10px";
            messageDiv.appendChild(actionBtn);
          }

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          clearQuickReplies();
          if (sender === "bot" && data.quick_replies) {
            data.quick_replies.forEach((reply) => {
              const replyBtn = document.createElement("button");
              replyBtn.className = "quick-reply-btn";
              replyBtn.textContent = reply.text;
              replyBtn.dataset.payload = reply.payload;
              quickRepliesContainer.appendChild(replyBtn);
            });
          }
        };

        const sendMessage = (userText) => {
          if (!userText || userText.trim() === "") return;

          clearQuickReplies();
          addMessage({ answer: userText }, "user");

          if (chatInput.value) {
            chatInput.value = "";
          }

          fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: userText }),
          })
            .then((response) => response.json())
            .then((data) => {
              addMessage(data, "bot");
            })
            .catch((error) => {
              console.error("Error with AI chat:", error);
              addMessage(
                {
                  answer: "I'm sorry, I'm having trouble connecting right now.",
                },
                "bot"
              );
            });
        };

        // MODIFIED: This now handles scroll, link, and prefill actions
        chatMessages.addEventListener("click", (event) => {
          if (event.target.classList.contains("chat-action-btn")) {
            const button = event.target;
            const actionType = button.dataset.actionType;
            const actionTarget = button.dataset.actionTarget;

            if (actionType === "scroll") {
              const targetElement = document.querySelector(actionTarget);
              if (targetElement) {
                targetElement.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              }
            } else if (actionType === "link") {
              window.open(actionTarget, "_blank");
            } else if (actionType === "prefill_and_scroll") {
              const prefillData = JSON.parse(button.dataset.prefill);
              const inputElement = document.getElementById(
                prefillData.target_id
              );
              if (inputElement) {
                inputElement.value = prefillData.value;
              }

              const targetElement = document.querySelector(actionTarget);
              if (targetElement) {
                targetElement.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
                // Highlight the form for the user
                targetElement.style.transition = "box-shadow 0.5s ease-in-out";
                targetElement.style.boxShadow =
                  "0 0 20px rgba(146, 243, 148, 0.8)";
                setTimeout(() => {
                  targetElement.style.boxShadow = "";
                }, 2000);
              }
            }

            chatContainer.classList.add("hidden");
          }
        });

        quickRepliesContainer.addEventListener("click", (event) => {
          if (event.target.classList.contains("quick-reply-btn")) {
            const button = event.target;
            const payload = button.dataset.payload;
            sendMessage(payload);
          }
        });

        if (chatSendBtn)
          chatSendBtn.addEventListener("click", () =>
            sendMessage(chatInput.value)
          );
        if (chatInput)
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage(chatInput.value);
          });

        const toggleChat = () => {
          chatContainer.classList.toggle("hidden");
          if (!chatContainer.classList.contains("hidden")) {
            // When opening the chat, reset to the initial greeting
            chatMessages.innerHTML = "";
            addMessage(
              {
                answer: "Hello! I am the MedGuard Assistant. How can I help?",
                quick_replies: [
                  { text: "How to report a drug?", payload: "guide to report" },
                  { text: "How to verify a drug?", payload: "verify" },
                  { text: "Check a batch status", payload: "status of batch" },
                ],
              },
              "bot"
            );
          }
        };

        if (chatToggleBtn) {
          chatToggleBtn.addEventListener("click", toggleChat);
          const chatCloseBtn = document.getElementById("chat-close-btn");
          if (chatCloseBtn) {
            chatCloseBtn.addEventListener("click", toggleChat);
          }
        }
      });
    </script>

    {% if session.admin_id %}
    <script src="{{ url_for('static', filename='admin_timer.js') }}"></script>
    {% endif %}
  </body>
</html>
