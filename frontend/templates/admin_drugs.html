{% extends "base.html" %}

{% block content %}
<style>
  .filter-form {
    margin-bottom: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .export-links {
    margin-bottom: 15px;
    text-align: right;
  }
  .delete-btn {
    background-color: #dc3545;
    color: white;
    border: none;
  }
  .delete-btn:hover {
    background-color: #c82333;
  }
  
  /* Custom Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal-content {
    background: rgba(47, 79, 79, 0.9);
    padding: 25px;
    border-radius: 12px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    border-top: 4px solid var(--mg-red);
  }
  .modal-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  
  @media (max-width: 768px) {
    .filter-form {
      flex-direction: column;
      align-items: stretch;
    }
    .filter-form .input, .filter-form .btn, .filter-form select {
      width: 100%;
      margin-bottom: 10px;
    }
    .export-links {
      text-align: center;
    }
    .export-links .btn {
      width: 100%;
      margin-bottom: 10px;
    }
  }
</style>

<div class="panel" style="color:#000;">
  <h2>{{ _('üíä Registered Drugs') }}</h2>
  <p style="opacity:0.8;">{{ _('Search, filter, or export registered drug batches.') }}</p>

  <form method="get" action="{{ url_for('admin_api.admin_drugs') }}" class="filter-form">
    <input type="text" name="search" value="{{ search }}" placeholder="{{ _('Search by name or batch number') }}" class="input" style="flex:2; min-width:200px; color:#000;">
    <select name="status" class="input" style="flex:1; min-width:150px; color:#000;">
      <option value="">{{ _('-- All --') }}</option>
      <option value="valid" {% if status=='valid' %}selected{% endif %}>{{ _('Valid') }}</option>
      <option value="expired" {% if status=='expired' %}selected{% endif %}>{{ _('Expired') }}</option>
      <option value="soon" {% if status=='soon' %}selected{% endif %}>{{ _('Expiring Soon') }}</option>
    </select>
    <button type="submit" class="btn btn-yellow">{{ _('üîç Search') }}</button>
  </form>

  <form method="get" action="{{ url_for('admin_api.admin_drugs') }}" class="filter-form">
    <input type="hidden" name="search" value="{{ search }}">
    <input type="hidden" name="status" value="{{ status }}">
    <label for="start" style="font-weight:bold;">{{ _('From:') }}</label>
    <input type="date" id="start" name="start" value="{{ start }}" class="input" style="color:#000;">
    <label for="end" style="font-weight:bold;">{{ _('To:') }}</label>
    <input type="date" id="end" name="end" value="{{ end }}" class="input" style="color:#000;">
    <button type="submit" class="btn btn-yellow">{{ _('üìÖ Apply') }}</button>
  </form>

  <div class="export-links">
    <a href="{{ url_for('admin_api.export_drugs_word', search=search, status=status, start=start, end=end) }}" class="btn btn-outline">{{ _('‚¨á Export Word') }}</a>
    <a href="{{ url_for('admin_api.export_drugs_pdf', search=search, status=status, start=start, end=end) }}" class="btn btn-outline">{{ _('‚¨á Export PDF') }}</a>
  </div>

  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
    <table class="table" id="drugs-table" style="width:100%; border-collapse: collapse; margin-top:15px; color:#000;">
      <thead style="background:#f4f4f4;">
        <tr>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Name') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Batch #') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Manufacturer') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Mfg Date') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Expiry Date') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Status') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Registered On') }}</th>
          <th style="padding:10px; border-bottom:2px solid #ccc; text-align:left;">{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for drug in drugs %}
        <tr style="border-bottom:1px solid #eee;">
          <td data-label="Name">{{ drug.name }}</td>
          <td data-label="Batch #">{{ drug.batch_number }}</td>
          <td data-label="Manufacturer">{{ drug.manufacturer }}</td>
          <td data-label="Mfg Date">{{ drug.mfg_date }}</td>
          <td data-label="Expiry Date">{{ drug.expiry_date }}</td>
          <td data-label="Status">
            {% if drug.expiry_date < current_date %}
              <span style="background:#ffdddd; color:#a00; padding:3px 8px; border-radius:12px; font-size:0.85em;">{{ _('Expired') }}</span>
            {% elif drug.expiry_date <= soon_date %}
              <span style="background:#fff3cd; color:#856404; padding:3px 8px; border-radius:12px; font-size:0.85em;">{{ _('Expiring Soon') }}</span>
            {% else %}
              <span style="background:#ddffdd; color:#060; padding:3px 8px; border-radius:12px; font-size:0.85em;">{{ _('Valid') }}</span>
            {% endif %}
          </td>
          <td data-label="Registered On">{{ drug.created_at }}</td>
          <td data-label="Actions">
              <button class="btn delete-btn" data-id="{{ drug.id }}" data-name="{{ drug.name }}">{{ _('Delete') }}</button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" style="padding:12px; text-align:center; color:#777;">{{ _('No drugs found.') }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if total_pages > 1 %}
  <div style="margin-top:20px; text-align:center;">
    {% if page > 1 %}
      <a href="{{ url_for('admin_api.admin_drugs', search=search, status=status, start=start, end=end, page=page-1) }}" class="btn">{{ _('‚¨Ö Prev') }}</a>
    {% endif %}
    <span style="margin:0 10px;">{{ _('Page') }} {{ page }} {{ _('of') }} {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="{{ url_for('admin_api.admin_drugs', search=search, status=status, start=start, end=end, page=page+1) }}" class="btn">{{ _('Next ‚û°') }}</a>
    {% endif %}
  </div>
  {% endif %}

  <div style="margin-top:20px; text-align:center;">
    <a href="{{ url_for('admin_api.admin_dashboard') }}" class="btn">{{ _('‚¨Ö Back to Dashboard') }}</a>
  </div>
</div>

<div id="delete-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--mg-yellow);">{{ _('Confirm Deletion') }}</h3>
        <p id="modal-text" style="color: var(--mg-white);">{{ _('Are you sure you want to delete this drug?') }}</p>
        <div class="modal-buttons">
            <button id="modal-cancel-btn" class="btn btn-outline">{{ _('Cancel') }}</button>
            <button id="modal-confirm-btn" class="btn delete-btn">{{ _('Delete') }}</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const drugsTable = document.getElementById('drugs-table');
    const modal = document.getElementById('delete-modal');
    const modalText = document.getElementById('modal-text');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    let drugToDeleteId = null;
    let rowToDelete = null;

    if (drugsTable) {
        drugsTable.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-btn')) {
                drugToDeleteId = event.target.dataset.id;
                const drugName = event.target.dataset.name;
                rowToDelete = event.target.closest('tr');
                
                modalText.textContent = `{{ _('Are you sure you want to delete the drug') }} "${drugName}"? {{ _('This action cannot be undone.') }}`;
                modal.style.display = 'flex';
            }
        });
    }

    const closeModal = () => {
        modal.style.display = 'none';
        drugToDeleteId = null;
        rowToDelete = null;
    };

    cancelBtn.addEventListener('click', closeModal);

    confirmBtn.addEventListener('click', () => {
        if (!drugToDeleteId) return;

        fetch(`/admin/drugs/delete/${drugToDeleteId}`, {
            method: 'DELETE',
        })
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(({ status, body }) => {
            if (status === 200) {
                // You could show a more elegant toast notification here
                alert(body.message); 
                if (rowToDelete) {
                    rowToDelete.remove();
                }
            } else {
                alert('Error: ' + body.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the drug.');
        })
        .finally(() => {
            closeModal();
        });
    });

    // Close modal if clicking on the overlay
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });
});
</script>
{% endblock %}