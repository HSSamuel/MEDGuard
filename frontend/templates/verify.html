{% extends "base.html" %} {% block content %}
<style>
  /* --- Base Card Styles --- */
  .card {
    max-width: 600px;
    margin: 40px auto;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 25px;
    font-family: Arial, sans-serif;
  }
  /* --- Dynamic Background Colors --- */
  .valid {
    background: #e8f5e9;
  }
  .expired {
    background: #fff8e1;
  }
  .notfound,
  .external_url {
    background: #ffebee;
  }
  .public_info_found,
  .unregistered_product_code {
    background: #e3f2fd;
  }

  /* --- Header and Status Styles --- */
  .header {
    text-align: center;
    margin-bottom: 20px;
  }
  .header h2 {
    margin: 0;
    font-size: 1.5em;
  }
  .status-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
  }
  .subtle {
    font-size: 0.95em;
    color: #555;
  }

  /* --- Details Table --- */
  .details-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    color: #333;
  }
  .details-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
  }

  /* --- General Styles --- */
  .verified-on {
    margin-top: 20px;
    text-align: center;
    font-size: 0.9em;
    color: #777;
  }
  .btn-link {
    display: inline-block;
    background: #007bff;
    color: #fff;
    padding: 12px 25px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    margin-top: 15px;
    transition: background 0.2s;
  }
  .btn-link:hover {
    background: #0056b3;
  }

  .next-steps {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
    text-align: left;
    color: #333;
  }
  .next-steps h3 {
    text-align: center;
    margin-bottom: 15px;
    color: #0056b3;
  }
  .next-steps ul {
    padding-left: 20px;
    margin-bottom: 0;
  }
  .next-steps li {
    margin-bottom: 10px;
  }

  .report-now-btn {
    display: block;
    width: 80%;
    margin: 20px auto 0 auto;
    background: var(--mg-red);
    color: #fff;
    text-align: center;
  }
  .report-now-btn:hover {
    background: #8c4a14;
  }
</style>

<div class="card {{ status }}">
  <div class="header">
    <img
      src="{{ url_for('static', filename='images/logo.png') }}"
      alt="MedGuard Logo"
      style="max-height: 60px; margin-bottom: 10px"
    />

    {% if anomaly_warning %}
    <div
      style="
        background: #fff3cd;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ffeeba;
        margin-bottom: 20px;
      "
    >
      <h3 style="margin-top: 0; color: #856404">
        {{ _('üö® Security Alert') }}
      </h3>
      <p style="margin-bottom: 0">{{ anomaly_warning }}</p>
    </div>
    {% endif %} {% if status == 'valid' %}
    <div class="status-icon" style="color: #2e7d32">‚úÖ</div>
    <h2 style="color: #2e7d32">{{ _('Batch Verified by MedGuard') }}</h2>
    <p class="subtle">
      {{ _('This is an authentic drug registered in the MedGuard system.') }}
    </p>
    {% elif status == 'expired' %}
    <div class="status-icon" style="color: #ff8f00">‚ö†Ô∏è</div>
    <h2 style="color: #ff8f00">{{ _('Warning: Drug Expired') }}</h2>
    <p class="subtle">
      {{ _('This is a registered drug, but it has passed its expiry date. Do not
      use.') }}
    </p>
    {% elif status == 'public_info_found' %}
    <div class="status-icon" style="color: #007bff">‚ÑπÔ∏è</div>
    <h2 style="color: #007bff">{{ _('Public Information Found') }}</h2>
    <p class="subtle" style="font-weight: bold">
      {{ _('Disclaimer: This information is from a public database and has
      <u>not</u> been independently verified by MedGuard.') }}
    </p>
    {% elif status == 'external_url' %}
    <div class="status-icon" style="color: #c62828">üåê</div>
    <h2 style="color: #c62828">{{ _('External Website Link') }}</h2>
    <p class="subtle">
      {{ _('This') }} {{ scan_type or 'code' }} {{ _('points to an external
      website. MedGuard cannot verify its authenticity. Proceed with caution.')
      }}
    </p>
    {% elif status == 'unregistered_product_code' %}
    <div class="status-icon" style="color: #007bff">‚ÑπÔ∏è</div>
    <h2 style="color: #007bff">{{ _('Unregistered Product Code') }}</h2>
    <p class="subtle">
      {{ _('This is a standard product, not a MedGuard code. While not flagged
      as counterfeit, we cannot verify it.') }}
    </p>
    {% else %} {# This handles 'notfound' and any other case #}
    <div class="status-icon" style="color: #c62828">‚ùå</div>
    <h2 style="color: #c62828">{{ _('Not Found in MedGuard System') }}</h2>
    <p class="subtle">
      {{ _('This') }} {{ scan_type or 'code' }} {{ _('is not registered in the
      MedGuard system. This drug may be counterfeit. Please report it.') }}
    </p>
    {% endif %}
  </div>

  {% if batch %}
  <table class="details-table">
    <tr>
      <td><strong>{{ _('Drug Name:') }}</strong></td>
      <td>{{ batch.drug_name }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('Batch Number:') }}</strong></td>
      <td>{{ batch.batch_number }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('Manufacturer:') }}</strong></td>
      <td>{{ batch.manufacturer }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('Expiry Date:') }}</strong></td>
      <td>{{ batch.expiry_date }}</td>
    </tr>
  </table>
  {% endif %} {% if public_data %}
  <table class="details-table">
    <tr>
      <td><strong>{{ _('Drug Name:') }}</strong></td>
      <td>{{ public_data.drug_name }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('Manufacturer:') }}</strong></td>
      <td>{{ public_data.manufacturer }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('NAFDAC Status:') }}</strong></td>
      <td>{{ public_data.status }}</td>
    </tr>
    <tr>
      <td><strong>{{ _('Details:') }}</strong></td>
      <td>{{ public_data.details }}</td>
    </tr>
  </table>
  {% endif %} {% if external_url %}
  <div style="text-align: center; word-wrap: break-word; color: #333">
    <p>{{ _('The scanned code links to the following address:') }}</p>
    <strong
      style="background: #eee; padding: 5px; border-radius: 4px; color: #000"
      >{{ external_url }}</strong
    >
    <br />
    <a
      href="{{ external_url }}"
      class="btn-link"
      target="_blank"
      rel="noopener noreferrer"
      >{{ _('Proceed to Website') }}</a
    >
  </div>
  {% endif %} {% if scanned_content %}
  <div style="text-align: center; word-wrap: break-word; color: #333">
    <p>
      {{ _('The scanned Code contained the following unrecognized data:') }}
    </p>
    <strong
      style="background: #eee; padding: 5px; border-radius: 4px; color: #000"
      >{{ scanned_content }}</strong
    >
  </div>
  {% endif %} {% if status == 'notfound' or status ==
  'unregistered_product_code' %}
  <div class="next-steps">
    <h3>{{ _('What To Do Next') }}</h3>
    <ul>
      <li>
        <strong>{{ _('Check NAFDAC:') }}</strong> {{ _('Use the official
        Greenbook or MAS.') }}
      </li>
      <li>
        <strong>{{ _('Report to MedGuard:') }}</strong> {{ _('If suspicious, use
        the report form on the main page.') }}
      </li>
      <li>
        <strong>{{ _('Report to NAFDAC:') }}</strong> {{ _('For an official
        report, contact them directly via') }}
        <a href="mailto:nafdac@nafdac.gov.ng">nafdac@nafdac.gov.ng</a>.
      </li>
    </ul>
    {% if scanned_content %}
    <a
      href="{{ url_for('root') }}?report_batch={{ scanned_content|urlencode }}"
      class="btn-link report-now-btn"
    >
      {{ _('Report This Product Now') }}
    </a>
    {% endif %}
  </div>
  {% endif %} {% if status == 'valid' and batch %}
  <div class="next-steps">
    <h3>{{ _('Experiencing a Side Effect?') }}</h3>
    <p style="text-align: center">
      {{ _('Help keep our medicines safe by reporting any unexpected reactions.
      Your contribution is vital for public health.') }}
    </p>
    <div style="text-align: center">
      <a
        href="{{ url_for('adr_report_form', drug_id=batch.id) }}"
        class="btn-link"
        style="background-color: #ff8f00"
        >{{ _('Report a Side Effect') }}</a
      >
    </div>
  </div>
  {% endif %} {% if status == 'valid' %}
  <div class="next-steps">
    <h3>Find Nearby Pharmacies</h3>
    <div id="nearby-pharmacies-list">
      <p><i>Getting your location to find nearby pharmacies...</i></p>
    </div>
  </div>
  {% endif %} {% if blockchain_history %}
  <div class="next-steps">
    <h3>Supply Chain Journey</h3>
    <ul style="list-style-type: none; padding-left: 0">
      {% for event in blockchain_history %}
      <li style="position: relative; padding-left: 25px; margin-bottom: 10px">
        <span style="position: absolute; left: 0; top: 0; color: #2ecc71"
          >‚úî</span
        >
        {{ event }}
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="verified-on">{{ _('Checked on') }} {{ verified_on }}</div>

  <div style="text-align: center; margin-top: 30px">
    <a href="/" class="btn-link" style="background-color: #555"
      >{{ _('Scan Another Code') }}</a
    >
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const pharmacyContainer = document.getElementById("nearby-pharmacies-list");

    if (pharmacyContainer) {
      if (!navigator.geolocation) {
        pharmacyContainer.innerHTML =
          "<p>Geolocation is not supported by your browser.</p>";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const { latitude, longitude } = position.coords;

          fetch(`/api/pharmacies/nearby?lat=${latitude}&lon=${longitude}`)
            .then((response) => {
              if (!response.ok) {
                throw new Error("Could not fetch pharmacy data.");
              }
              return response.json();
            })
            .then((pharmacies) => {
              pharmacyContainer.innerHTML = "";

              if (pharmacies && pharmacies.length > 0) {
                const list = document.createElement("ul");
                list.style.listStyle = "none";
                list.style.paddingLeft = "0";

                pharmacies.forEach((p) => {
                  const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${p.lat},${p.lng}`;
                  const item = document.createElement("li");
                  item.style.marginBottom = "15px";
                  item.innerHTML = `
                    <strong>${p.name}</strong> (Rating: ${p.rating})<br>
                    <small>${p.address}</small><br>
                    <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">View on Map</a>
                  `;
                  list.appendChild(item);
                });
                pharmacyContainer.appendChild(list);
              } else {
                pharmacyContainer.innerHTML =
                  "<p>No pharmacies found within a 5km radius.</p>";
              }
            })
            .catch((error) => {
              console.error("Error fetching pharmacies:", error);
              pharmacyContainer.innerHTML =
                "<p style='color: red;'>An error occurred while trying to find pharmacies.</p>";
            });
        },
        () => {
          pharmacyContainer.innerHTML =
            "<p style='color: orange;'>Location permission was denied. Please enable location services in your browser to use this feature.</p>";
        }
      );
    }
  });
</script>
{% endblock %}
