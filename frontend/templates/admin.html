{% extends "base.html" %} {% block content %}
<style>
  /* General mobile adjustments */
  @media (max-width: 768px) {
    .panel {
      padding: 15px;
    }
    .inline-form {
      flex-direction: column;
      align-items: stretch;
    }
    .inline-form .input,
    .inline-form .btn {
      width: 100%;
      margin-bottom: 10px;
    }
    .desktop-only {
      display: none;
    }
    h2 {
      font-size: 1.2em;
    }
  }

  /* Responsive navigation shortcuts */
  .nav-shortcuts {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
  }
  @media (max-width: 768px) {
    .nav-shortcuts {
      flex-direction: column;
    }
    .nav-shortcuts .btn {
      width: 100%;
      text-align: center;
    }
  }

  /* Responsive date filters */
  .date-filters {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  @media (max-width: 768px) {
    .date-filters {
      flex-direction: column;
      align-items: stretch;
    }
    .date-filters .input,
    .date-filters .btn {
      width: 100%;
    }
  }
  .status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
  }
  .status-new {
    background-color: #f39c12;
  }
  .status-review {
    background-color: #3498db;
  }
  .status-resolved {
    background-color: #2ecc71;
  }
</style>

<div class="panel">
  <div
    style="
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    "
  >
    <h2>{{ _('üõ† Admin ‚Äî Register New Drug Batch') }}</h2>

    <div
      id="timers-container"
      style="display: flex; align-items: center; gap: 15px"
    >
      <div
        id="live-clock-container"
        style="
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.9em;
          opacity: 0.9;
          background: rgb(0, 0, 0);
          padding: 5px 12px;
          border-radius: 6px;
        "
      >
        <span>üóìÔ∏è</span>
        <span id="live-clock">{{ _('Loading time...') }}</span>
      </div>
      <div
        id="session-timer-container"
        style="
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.9em;
          opacity: 0.9;
          background: rgb(0, 0, 0);
          padding: 5px 12px;
          border-radius: 6px;
          border-left: 3px solid #f39c12;
        "
      >
        <span>‚è≥</span>
        <span
          >{{ _('Session ends in:') }}
          <strong
            id="session-countdown-display"
            style="min-width: 45px; display: inline-block; text-align: center"
            >--:--</strong
          ></span
        >
      </div>
    </div>
  </div>

  <p style="opacity: 0.85; margin-top: 0">
    {{ _('Use this form to register a new drug batch and generate its QR code instantly.') }}
  </p>
</div>

<div class="panel nav-shortcuts">
  <a href="{{ url_for('admin_api.admin_drugs') }}" class="btn"
    >{{ _('üíä Registered Drugs') }}</a
  >
  <a href="{{ url_for('render_sms_check') }}" class="btn btn-outline"
    >{{ _('üì± Simulate SMS') }}</a
  >
</div>

<div class="panel">
  <h2>{{ _('üì¶ Batch Details') }}</h2>

  <div
    id="registration-scanner-container"
    style="display: none; margin-bottom: 20px; text-align: center"
  >
    <div
      id="registration-reader"
      style="
        width: 300px;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 8px;
      "
    ></div>
    <button
      id="stop-reg-scan-btn"
      class="btn btn-outline"
      style="margin-top: 10px"
    >
      {{ _('Close Scanner') }}
    </button>
  </div>

  <form
    id="register-form"
    action="{{ url_for('admin_api.admin_register') }}?scroll=qr"
    method="post"
  >
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="drug-name"
        name="name"
        class="input"
        placeholder="{{ _('Drug name') }}"
        required
      />
      <input
        id="batch-number"
        name="batch_number"
        class="input"
        placeholder="{{ _('Batch number') }}"
        required
      />
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <div style="flex: 1">
        <label
          for="mfg-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >{{ _('Mfg Date') }}</label
        >
        <input
          id="mfg-date"
          name="mfg_date"
          type="date"
          class="input"
          required
        />
      </div>
      <div style="flex: 1">
        <label
          for="expiry-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >{{ _('Expiry Date') }}</label
        >
        <input
          id="expiry-date"
          name="expiry_date"
          type="date"
          class="input"
          required
        />
      </div>
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="manufacturer"
        name="manufacturer"
        class="input"
        placeholder="{{ _('Manufacturer') }}"
        required
      />
    </div>
    <div style="margin-top: 20px" class="inline-form">
      <button type="submit" class="btn btn-yellow">
        {{ _('Register &amp; Get QR') }}
      </button>
      <button
        type="button"
        id="start-reg-scan-btn"
        class="btn"
        style="background-color: #007bff; color: white"
      >
        {{ _('üì∑ Scan to Pre-fill') }}
      </button>
    </div>
  </form>
</div>

<div
  id="qr-result"
  class="panel"
  {%
  if
  not
  qr_image
  %}style="display:none;"
  {%
  endif
  %}
>
  <h2>{{ _('üìÑ Generated QR Code') }}</h2>
  <p>{{ _('Right-click and save the image below to print or share.') }}</p>
  {% if qr_image %}
  <img
    src="data:image/png;base64,{{ qr_image }}"
    alt="QR Code"
    style="
      max-width: 200px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
    "
  />
  {% endif %}
</div>

<div class="panel" id="counterfeit-reports">
  <h2>{{ _('üö® Counterfeit Reports') }}</h2>
  <div class="nav-shortcuts" style="margin-bottom: 15px">
    <a
      href="{{ url_for('admin_api.admin_reports_today') }}?scroll=reports"
      id="new-reports-btn-today"
      class="btn btn-yellow"
      >{{ _('Today‚Äôs Reports') }}
      <span
        id="new-report-badge"
        class="badge"
        style="
          background: #dc3545;
          color: white;
          display: none;
          margin-left: 8px;
        "
        >0</span
      ></a
    >
    <a
      href="{{ url_for('admin_api.admin_reports') }}?scroll=reports"
      id="new-reports-btn"
      class="btn btn-outline"
      >{{ _('View All Reports') }}</a
    >
  </div>

  <div style="margin-bottom: 20px">
    <input
      type="text"
      id="report-search"
      class="input"
      placeholder="{{ _('üîç Search reports...') }}"
      style="width: 100%"
    />
  </div>

  <div class="date-filters" style="margin-bottom: 20px">
    <label for="start" style="font-weight: bold">{{ _('From:') }}</label>
    <input type="date" id="start" name="start" class="input" required />
    <label for="end" style="font-weight: bold">{{ _('To:') }}</label>
    <input type="date" id="end" name="end" class="input" required />
    <a id="range-reports-btn" href="#" class="btn btn-yellow">{{ _('Filter') }}</a>
  </div>

  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch">
    <table class="table" id="reports-table">
      <thead>
        <tr>
          <th data-label="ID">{{ _('ID') }}</th>
          <th data-label="Drug Name">{{ _('Drug Name') }}</th>
          <th data-label="Batch">{{ _('Batch') }}</th>
          <th data-label="Location">{{ _('Location') }}</th>
          <th data-label="Note">{{ _('Note') }}</th>
          <th data-label="Image">{{ _('Image') }}</th>
          <th data-label="Analysis">{{ _('Analysis') }}</th>
          <th data-label="Date">{{ _('Date') }}</th>
          <th data-label="Reporter">{{ _('Reporter') }}</th>
          <th data-label="Status">{{ _('Status') }}</th>
          <th data-label="Actions">{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody id="reports-body">
        {% if reports is defined and reports %} {% for report in reports %}
        <tr
          class="report-row {% if report.status == 0 %}new{% endif %}"
          data-id="{{ report.id }}"
        >
          <td data-label="ID">{{ report.id }}</td>
          <td data-label="Drug Name">{{ report.drug_name or "-" }}</td>
          <td data-label="Batch">{{ report.batch_number }}</td>
          <td data-label="Location">{{ report.location or "-" }}</td>
          <td data-label="Note" class="note-column">
            {{ report.note or "-" }}
          </td>
          <td data-label="Image">
            {% if report.image_filename %}
            <a
              href="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
              target="_blank"
            >
              <img
                src="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
                width="80"
                alt="Report Image"
              />
            </a>
            {% else %} {{ _('No Image') }} {% endif %}
          </td>
          <td data-label="Analysis">
            <div class="analysis-container" id="analysis-{{ report.id }}">
              {% if report.image_analysis_result %}
              <p>{{ report.image_analysis_result }}</p>
              {% elif report.image_filename %}
              <button
                class="btn btn-outline analyze-btn"
                data-id="{{ report.id }}"
              >
                {{ _('Analyze') }}
              </button>
              {% else %} {{ _('N/A') }} {% endif %}
            </div>
          </td>
          <td data-label="Date">{{ report.reported_on.split(' ')[0] }}</td>
          <td data-label="Reporter">
            {{ report.submitted_by or "Anonymous" }}
          </td>
          <td data-label="Status">
            {% if report.status == 0 %}
            <span class="badge badge-new">{{ _('New') }}</span>
            {% else %}
            <span class="badge badge-checked">{{ _('Checked') }}</span>
            {% endif %}
          </td>
          <td data-label="Actions">
            <button
              class="btn delete-report-btn"
              data-id="{{ report.id }}"
              style="background-color: #dc3545; color: white"
            >
              {{ _('Delete') }}
            </button>
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="11" style="text-align: center">
            {{ _('No reports submitted yet.') }}
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="panel" id="adr-reports">
  <h2>{{ _('üíä Adverse Drug Reaction Reports') }}</h2>

  <form
    method="get"
    action="{{ url_for('admin_api.admin_dashboard') }}"
    class="inline-form"
    style="margin-bottom: 20px"
  >
    <input
      type="text"
      name="adr_search"
      value="{{ adr_search }}"
      placeholder="{{ _('Search by drug, batch, or reaction...') }}"
      class="input"
      style="flex-grow: 1"
    />
    <label for="adr_start">{{ _('From:') }}</label>
    <input
      type="date"
      id="adr_start"
      name="adr_start"
      value="{{ adr_start }}"
      class="input"
    />
    <label for="adr_end">{{ _('To:') }}</label>
    <input
      type="date"
      id="adr_end"
      name="adr_end"
      value="{{ adr_end }}"
      class="input"
    />
    <button type="submit" class="btn btn-yellow">{{ _('Filter ADR') }}</button>
  </form>

  <div class="export-links" style="text-align: right; margin-bottom: 20px">
    <a
      href="{{ url_for('adr_api.export_adr_reports_word', adr_search=adr_search, adr_start=adr_start, adr_end=adr_end) }}"
      class="btn btn-outline"
      >{{ _('Export Word') }}</a
    >
    <a
      href="{{ url_for('adr_api.export_adr_reports_pdf', adr_search=adr_search, adr_start=adr_start, adr_end=adr_end) }}"
      class="btn btn-outline"
      >{{ _('Export PDF') }}</a
    >
  </div>

  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch">
    <table class="table" id="adr-reports-table">
      <thead>
        <tr>
          <th>{{ _('ID') }}</th>
          <th>{{ _('Drug Name') }}</th>
          <th>{{ _('Batch Number') }}</th>
          <th>{{ _('Patient Info') }}</th>
          <th>{{ _('Reaction Description') }}</th>
          <th>{{ _('Report Date') }}</th>
          <th>{{ _('Status') }}</th>
          <th>{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody>
        {% if adr_reports %} {% for report in adr_reports %}
        <tr data-id="{{ report.id }}">
          <td data-label="ID">{{ report.id }}</td>
          <td data-label="Drug Name">{{ report.drug_name }}</td>
          <td data-label="Batch Number">{{ report.batch_number }}</td>
          <td data-label="Patient Info">
            {{ report.patient_age_range or 'N/A' }} / {{ report.patient_gender
            or 'N/A' }}
          </td>
          <td data-label="Reaction">{{ report.reaction_description }}</td>
          <td data-label="Report Date">
            {{ report.report_date.split(' ')[0] }}
          </td>
          <td data-label="Status">
            <span
              class="status-badge status-{{ (report.status or 'new').lower().replace(' ', '-') }}"
              >{{ report.status or 'New' }}</span
            >
          </td>
          <td data-label="Actions">
            <button
              class="btn adr-delete-btn"
              data-id="{{ report.id }}"
              style="background-color: #dc3545; color: white"
            >
              {{ _('Delete') }}
            </button>
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="8" style="text-align: center">
            {{ _('No Adverse Drug Reaction reports match the current filters.') }}
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='admin.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Reusable Toast Notification function ---
    const showToast = (message, isError = false) => {
      const toast = document.createElement("div");
      toast.className = "toast-notification";
      if (isError) toast.classList.add("error");
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 100);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    };

    // --- Custom Confirmation Modal Logic ---
    const confirmModal = document.getElementById("confirm-modal");
    if (confirmModal) {
      const confirmModalTitle = document.getElementById("confirm-modal-title");
      const confirmModalText = document.getElementById("confirm-modal-text");
      const confirmBtn = document.getElementById("confirm-modal-confirm-btn");
      const cancelBtn = document.getElementById("confirm-modal-cancel-btn");

      const showConfirmModal = (title, text, onConfirm) => {
        confirmModalTitle.textContent = title;
        confirmModalText.textContent = text;
        confirmModal.style.display = "flex";

        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener("click", () => {
          onConfirm();
          hideConfirmModal();
        });
      };

      const hideConfirmModal = () => {
        confirmModal.style.display = "none";
      };

      cancelBtn.addEventListener("click", hideConfirmModal);

      // --- Counterfeit Report Deletion Handler ---
      const reportsTable = document.getElementById("reports-table");
      reportsTable.addEventListener("click", (event) => {
        if (event.target.classList.contains("delete-report-btn")) {
          // ... (existing counterfeit deletion logic remains here) ...
        }
      });

      // --- CORRECTED: ADR Reports Table Actions ---
      const adrTable = document.getElementById("adr-reports-table");
      if (adrTable) {
        adrTable.addEventListener("click", (event) => {
          if (event.target.classList.contains("adr-delete-btn")) {
            const button = event.target;
            const reportId = button.dataset.id;
            const row = button.closest("tr");

            showConfirmModal(
              "{{ _('Confirm Deletion') }}",
              `{{ _('Are you sure you want to delete ADR Report #') }}${reportId}? {{ _('This is permanent.') }}`,
              () => {
                fetch(`/api/adr-report/${reportId}`, { method: "DELETE" })
                  .then((response) =>
                    response
                      .json()
                      .then((data) => ({ status: response.status, body: data }))
                  )
                  .then(({ status, body }) => {
                    if (status === 200) {
                      showToast(body.message);
                      row.remove();
                    } else {
                      throw new Error(body.error);
                    }
                  })
                  .catch((error) =>
                    showToast(`{{ _('Failed to delete report:') }} ${error.message}`, true)
                  );
              }
            );
          }
        });
      }
    }

    // --- Live Clock, Notifications, and other scripts remain here ---
    // ... (rest of the script) ...
    // --- Live Clock Functionality ---
    const clockElement = document.getElementById("live-clock");
    if (clockElement) {
      const updateClock = () => {
        const now = new Date();
        const options = {
          timeZone: "Africa/Lagos",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: true,
        };
        clockElement.textContent =
          new Intl.DateTimeFormat("en-US", options).format(now) + " (WAT)";
      };
      updateClock();
      setInterval(updateClock, 1000);
    }

    // --- Real-Time Notification System ---
    let currentNewReportCount = 0;
    const badge = document.getElementById("new-report-badge");
    let audioCtx;

    const playNotificationSound = () => {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.001,
        audioCtx.currentTime + 0.5
      );
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.5);
    };

    const checkNewReports = () => {
      fetch("{{ url_for('admin_api.reports_count') }}")
        .then((response) => response.json())
        .then((data) => {
          const newCount = data.count;
          if (newCount > 0) {
            badge.textContent = newCount;
            badge.style.display = "inline-block";
            if (newCount > currentNewReportCount) {
              playNotificationSound();
            }
          } else {
            badge.style.display = "none";
          }
          currentNewReportCount = newCount;
        })
        .catch((error) =>
          console.error("{{ _('Error checking for new reports:') }}", error)
        );
    };

    checkNewReports();
    setInterval(checkNewReports, 10000);

    document.body.addEventListener(
      "click",
      () => {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
      },
      { once: true }
    );

    // --- Other page scripts ---
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const rangeBtn = document.getElementById("range-reports-btn");

    if (rangeBtn) {
      rangeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const start = startInput.value;
        const end = endInput.value;
        if (!start || !end) {
          alert("{{ _('Please select both a start and end date.') }}");
          return;
        }
        window.location.href = `{{ url_for('admin_api.admin_reports_range') }}?start=${start}&end=${end}&scroll=reports`;
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get("scroll");
    if (scrollTo) {
      const element = document.getElementById(
        scrollTo === "qr" ? "qr-result" : "counterfeit-reports"
      );
      if (element) {
        element.scrollIntoView({ behavior: "smooth" });
      }
    }
  });
</script>
{% endblock %}