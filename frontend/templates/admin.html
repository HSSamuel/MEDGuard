{% extends "base.html" %} {% block content %}
<style>
  /* General mobile adjustments */
  @media (max-width: 768px) {
    .panel {
      padding: 15px;
    }
    .inline-form {
      flex-direction: column;
      align-items: stretch;
    }
    .inline-form .input,
    .inline-form .btn {
      width: 100%;
      margin-bottom: 10px;
    }
    .desktop-only {
      display: none;
    }
    h2 {
      font-size: 1.2em;
    }
    #logout-form {
      position: static;
      margin-bottom: 15px;
    }
    #logout-btn {
      width: 100%;
    }
  }

  /* Responsive navigation shortcuts */
  .nav-shortcuts {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
  }
  @media (max-width: 768px) {
    .nav-shortcuts {
      flex-direction: column;
    }
    .nav-shortcuts .btn {
      width: 100%;
      text-align: center;
    }
  }

  /* Responsive date filters */
  .date-filters {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  @media (max-width: 768px) {
    .date-filters {
      flex-direction: column;
      align-items: stretch;
    }
    .date-filters .input,
    .date-filters .btn {
      width: 100%;
    }
  }
</style>

<form
  id="logout-form"
  action="{{ url_for('admin_logout') }}"
  method="post"
  style="position: fixed; top: 15px; right: 20px; z-index: 10000; margin: 0"
>
  <input type="hidden" name="csrf" value="{{ session['csrf'] }}" />
  <button
    type="submit"
    id="logout-btn"
    class="btn"
    style="background: #dc3545; color: white"
  >
    🚪 <span class="desktop-only">Logout</span>
  </button>
</form>

<div
  id="session-timer"
  class="panel"
  style="
    background: #ffeb3b;
    border-left: 5px solid #f57c00;
    font-weight: bold;
    font-size: 1.1em;
    color: #000;
    text-align: center;
  "
>
  ⏳ Session expires in <span id="time-left">05:00</span> due to inactivity.
</div>

<div class="panel">
  <h2>🛠 Admin — Register New Drug Batch</h2>
  <p style="opacity: 0.85; margin-top: 0">
    Use this form to register a new drug batch and generate its QR code
    instantly.
  </p>
</div>

<div class="panel nav-shortcuts">
  <a href="{{ url_for('admin_api.admin_drugs') }}" class="btn"
    >💊 Registered Drugs</a
  >
  <a href="{{ url_for('render_sms_check') }}" class="btn btn-outline"
    >📱 Simulate SMS</a
  >
</div>

<div class="panel">
  <h2>📦 Batch Details</h2>

  <div
    id="registration-scanner-container"
    style="display: none; margin-bottom: 20px; text-align: center"
  >
    <div
      id="registration-reader"
      style="
        width: 300px;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 8px;
      "
    ></div>
    <button
      id="stop-reg-scan-btn"
      class="btn btn-outline"
      style="margin-top: 10px"
    >
      Close Scanner
    </button>
  </div>

  <form
    id="register-form"
    action="{{ url_for('admin_api.admin_register') }}?scroll=qr"
    method="post"
  >
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="drug-name"
        name="name"
        class="input"
        placeholder="Drug name"
        required
      />
      <input
        id="batch-number"
        name="batch_number"
        class="input"
        placeholder="Batch number"
        required
      />
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <div style="flex: 1">
        <label
          for="mfg-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >Mfg Date</label
        >
        <input
          id="mfg-date"
          name="mfg_date"
          type="date"
          class="input"
          required
        />
      </div>
      <div style="flex: 1">
        <label
          for="expiry-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >Expiry Date</label
        >
        <input
          id="expiry-date"
          name="expiry_date"
          type="date"
          class="input"
          required
        />
      </div>
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="manufacturer"
        name="manufacturer"
        class="input"
        placeholder="Manufacturer"
        required
      />
    </div>
    <div style="margin-top: 20px" class="inline-form">
      <button type="submit" class="btn btn-yellow">
        Register &amp; Get QR
      </button>
      <button
        type="button"
        id="start-reg-scan-btn"
        class="btn"
        style="background-color: #007bff; color: white"
      >
        📷 Scan to Pre-fill
      </button>
    </div>
  </form>
</div>

<div
  id="qr-result"
  class="panel"
  {%
  if
  not
  qr_image
  %}style="display:none;"
  {%
  endif
  %}
>
  <h2>📄 Generated QR Code</h2>
  <p>Right-click and save the image below to print or share.</p>
  {% if qr_image %}
  <img
    src="data:image/png;base64,{{ qr_image }}"
    alt="QR Code"
    style="
      max-width: 200px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
    "
  />
  {% endif %}
</div>

<div class="panel" id="counterfeit-reports">
  <h2>🚨 Counterfeit Reports</h2>
  <div class="nav-shortcuts" style="margin-bottom: 15px">
    <a
      href="{{ url_for('admin_api.admin_reports_today') }}?scroll=reports"
      id="new-reports-btn-today"
      class="btn btn-yellow"
      >Today’s Reports
      <span
        id="report-count"
        class="badge"
        style="background: #dc3545; color: white"
        >{{ reports|length if reports is defined else 0 }}</span
      ></a
    >
    <a
      href="{{ url_for('admin_api.admin_reports') }}?scroll=reports"
      id="new-reports-btn"
      class="btn btn-outline"
      >View All Reports</a
    >
  </div>

  <div style="margin-bottom: 20px">
    <input
      type="text"
      id="report-search"
      class="input"
      placeholder="🔍 Search reports..."
      style="width: 100%"
    />
  </div>

  <div class="date-filters" style="margin-bottom: 20px">
    <label for="start" style="font-weight: bold">From:</label>
    <input type="date" id="start" name="start" class="input" required />
    <label for="end" style="font-weight: bold">To:</label>
    <input type="date" id="end" name="end" class="input" required />
    <a id="range-reports-btn" href="#" class="btn btn-yellow">Filter</a>
  </div>

  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch">
    <table class="table" id="reports-table">
      <thead>
        <tr>
          <th data-sort="number">ID</th>
          <th data-sort="string">Drug Name</th>
          <th data-sort="string">Batch</th>
          <th data-sort="string">Location</th>
          <th data-sort="string">Note</th>
          <th>Image</th>
          <th>Analysis</th>
          <th data-sort="date">Date</th>
          <th data-sort="string">Reporter</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="reports-body">
        {% if reports is defined and reports %} {% for report in reports %}
        <tr
          class="report-row {% if report.status == 0 %}new{% endif %}"
          data-id="{{ report.id }}"
        >
          <td>{{ report.id }}</td>
          <td>{{ report.drug_name or "-" }}</td>
          <td>{{ report.batch_number }}</td>
          <td>{{ report.location or "-" }}</td>
          <td class="note-column">{{ report.note or "-" }}</td>
          <td>
            {% if report.image_filename %}
            <a
              href="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
              target="_blank"
            >
              <img
                src="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
                width="80"
                alt="Report Image"
              />
            </a>
            {% else %} No Image {% endif %}
          </td>
          <td>
            <div class="analysis-container" id="analysis-{{ report.id }}">
              {% if report.image_analysis_result %}
              <p>{{ report.image_analysis_result }}</p>
              {% elif report.image_filename %}
              <button
                class="btn btn-outline analyze-btn"
                data-id="{{ report.id }}"
              >
                Analyze
              </button>
              {% else %} N/A {% endif %}
            </div>
          </td>
          <td>{{ report.reported_on.split(' ')[0] }}</td>
          <td>{{ report.submitted_by or "Anonymous" }}</td>
          <td>
            {% if report.status == 0 %}
            <span class="badge badge-new">New</span>
            {% else %}
            <span class="badge badge-checked">Checked</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="10" style="text-align: center">
            No reports submitted yet.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div
  id="timeout-modal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  "
>
  <div
    style="
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 300px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    "
  >
    <h3>⚠️ Session Expiring</h3>
    <p>
      Your session will expire in <span id="modal-time-left">30</span> seconds.
    </p>
    <button id="stay-logged-in" class="btn btn-yellow" style="margin-top: 10px">
      Stay Logged In
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='admin.js') }}"></script>
<script src="{{ url_for('static', filename='admin_timer.js') }}"></script>
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const rangeBtn = document.getElementById("range-reports-btn");

    if (rangeBtn) {
      rangeBtn.addEventListener("click", () => {
        const start = startInput.value;
        const end = endInput.value;
        if (!start || !end) {
          alert("Please select start and end dates");
          return;
        }
        window.location.href = `{{ url_for('admin_api.admin_reports_range') }}?start=${start}&end=${end}&scroll=reports`;
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get("scroll");
    if (scrollTo) {
      const element = document.getElementById(
        scrollTo === "qr" ? "qr-result" : "counterfeit-reports"
      );
      if (element) {
        element.scrollIntoView({ behavior: "smooth" });
      }
    }
  });
</script>
{% endblock %}
