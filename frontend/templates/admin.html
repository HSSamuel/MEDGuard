{% extends "base.html" %} {% block content %}
<style>
  /* General mobile adjustments */
  @media (max-width: 768px) {
    .panel {
      padding: 15px;
    }
    .inline-form {
      flex-direction: column;
      align-items: stretch;
    }
    .inline-form .input,
    .inline-form .btn {
      width: 100%;
      margin-bottom: 10px;
    }
    .desktop-only {
      display: none;
    }
    h2 {
      font-size: 1.2em;
    }
  }

  /* Responsive navigation shortcuts */
  .nav-shortcuts {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
  }
  @media (max-width: 768px) {
    .nav-shortcuts {
      flex-direction: column;
    }
    .nav-shortcuts .btn {
      width: 100%;
      text-align: center;
    }
  }

  /* Responsive date filters */
  .date-filters {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  @media (max-width: 768px) {
    .date-filters {
      flex-direction: column;
      align-items: stretch;
    }
    .date-filters .input,
    .date-filters .btn {
      width: 100%;
    }
  }
</style>

<div class="panel">
  <h2>🛠 Admin — Register New Drug Batch</h2>
  <p style="opacity: 0.85; margin-top: 0">
    Use this form to register a new drug batch and generate its QR code
    instantly.
  </p>
</div>

<div class="panel nav-shortcuts">
  <a href="{{ url_for('admin_api.admin_drugs') }}" class="btn"
    >💊 Registered Drugs</a
  >
  <a href="{{ url_for('render_sms_check') }}" class="btn btn-outline"
    >📱 Simulate SMS</a
  >
</div>

<div class="panel">
  <h2>📦 Batch Details</h2>

  <div
    id="registration-scanner-container"
    style="display: none; margin-bottom: 20px; text-align: center"
  >
    <div
      id="registration-reader"
      style="
        width: 300px;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 8px;
      "
    ></div>
    <button
      id="stop-reg-scan-btn"
      class="btn btn-outline"
      style="margin-top: 10px"
    >
      Close Scanner
    </button>
  </div>

  <form
    id="register-form"
    action="{{ url_for('admin_api.admin_register') }}?scroll=qr"
    method="post"
  >
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="drug-name"
        name="name"
        class="input"
        placeholder="Drug name"
        required
      />
      <input
        id="batch-number"
        name="batch_number"
        class="input"
        placeholder="Batch number"
        required
      />
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <div style="flex: 1">
        <label
          for="mfg-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >Mfg Date</label
        >
        <input
          id="mfg-date"
          name="mfg_date"
          type="date"
          class="input"
          required
        />
      </div>
      <div style="flex: 1">
        <label
          for="expiry-date"
          style="display: block; font-weight: bold; margin-bottom: 4px"
          >Expiry Date</label
        >
        <input
          id="expiry-date"
          name="expiry_date"
          type="date"
          class="input"
          required
        />
      </div>
    </div>
    <div class="inline-form" style="margin-bottom: 8px">
      <input
        id="manufacturer"
        name="manufacturer"
        class="input"
        placeholder="Manufacturer"
        required
      />
    </div>
    <div style="margin-top: 20px" class="inline-form">
      <button type="submit" class="btn btn-yellow">
        Register &amp; Get QR
      </button>
      <button
        type="button"
        id="start-reg-scan-btn"
        class="btn"
        style="background-color: #007bff; color: white"
      >
        📷 Scan to Pre-fill
      </button>
    </div>
  </form>
</div>

<div
  id="qr-result"
  class="panel"
  {%
  if
  not
  qr_image
  %}style="display:none;"
  {%
  endif
  %}
>
  <h2>📄 Generated QR Code</h2>
  <p>Right-click and save the image below to print or share.</p>
  {% if qr_image %}
  <img
    src="data:image/png;base64,{{ qr_image }}"
    alt="QR Code"
    style="
      max-width: 200px;
      background: #fff;
      padding: 10px;
      border-radius: 8px;
    "
  />
  {% endif %}
</div>

<div class="panel" id="counterfeit-reports">
  <h2>🚨 Counterfeit Reports</h2>
  <div class="nav-shortcuts" style="margin-bottom: 15px">
    <a
      href="{{ url_for('admin_api.admin_reports_today') }}?scroll=reports"
      id="new-reports-btn-today"
      class="btn btn-yellow"
      >Today’s Reports
      <span
        id="new-report-badge"
        class="badge"
        style="background: #dc3545; color: white; display: none; margin-left: 8px;"
        >0</span
      ></a
    >
    <a
      href="{{ url_for('admin_api.admin_reports') }}?scroll=reports"
      id="new-reports-btn"
      class="btn btn-outline"
      >View All Reports</a
    >
  </div>

  <div style="margin-bottom: 20px">
    <input
      type="text"
      id="report-search"
      class="input"
      placeholder="🔍 Search reports..."
      style="width: 100%"
    />
  </div>

  <div class="date-filters" style="margin-bottom: 20px">
    <label for="start" style="font-weight: bold">From:</label>
    <input type="date" id="start" name="start" class="input" required />
    <label for="end" style="font-weight: bold">To:</label>
    <input type="date" id="end" name="end" class="input" required />
    <a id="range-reports-btn" href="#" class="btn btn-yellow">Filter</a>
  </div>

  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch">
    <table class="table" id="reports-table">
      <thead>
        <tr>
          <th data-label="ID">ID</th>
          <th data-label="Drug Name">Drug Name</th>
          <th data-label="Batch">Batch</th>
          <th data-label="Location">Location</th>
          <th data-label="Note">Note</th>
          <th data-label="Image">Image</th>
          <th data-label="Analysis">Analysis</th>
          <th data-label="Date">Date</th>
          <th data-label="Reporter">Reporter</th>
          <th data-label="Status">Status</th>
        </tr>
      </thead>
      <tbody id="reports-body">
        {% if reports is defined and reports %} {% for report in reports %}
        <tr
          class="report-row {% if report.status == 0 %}new{% endif %}"
          data-id="{{ report.id }}"
        >
          <td data-label="ID">{{ report.id }}</td>
          <td data-label="Drug Name">{{ report.drug_name or "-" }}</td>
          <td data-label="Batch">{{ report.batch_number }}</td>
          <td data-label="Location">{{ report.location or "-" }}</td>
          <td data-label="Note" class="note-column">{{ report.note or "-" }}</td>
          <td data-label="Image">
            {% if report.image_filename %}
            <a
              href="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
              target="_blank"
            >
              <img
                src="{{ url_for('static', filename='uploads/' + report.image_filename) }}"
                width="80"
                alt="Report Image"
              />
            </a>
            {% else %} No Image {% endif %}
          </td>
          <td data-label="Analysis">
            <div class="analysis-container" id="analysis-{{ report.id }}">
              {% if report.image_analysis_result %}
              <p>{{ report.image_analysis_result }}</p>
              {% elif report.image_filename %}
              <button
                class="btn btn-outline analyze-btn"
                data-id="{{ report.id }}"
              >
                Analyze
              </button>
              {% else %} N/A {% endif %}
            </div>
          </td>
          <td data-label="Date">{{ report.reported_on.split(' ')[0] }}</td>
          <td data-label="Reporter">{{ report.submitted_by or "Anonymous" }}</td>
          <td data-label="Status">
            {% if report.status == 0 %}
            <span class="badge badge-new">New</span>
            {% else %}
            <span class="badge badge-checked">Checked</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %} {% else %}
        <tr>
          <td colspan="10" style="text-align: center">
            No reports submitted yet.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %} {% block scripts %}
<script src="{{ url_for('static', filename='admin.js') }}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Real-Time Notification System ---
    let currentNewReportCount = 0;
    const badge = document.getElementById("new-report-badge");
    let audioCtx; // To be initialized on first user interaction

    // Function to play a notification sound
    const playNotificationSound = () => {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A sharp, clear beep
      gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(
        0.001,
        audioCtx.currentTime + 0.5
      );
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.5);
    };

    // Function to check for new reports
    const checkNewReports = () => {
      fetch("{{ url_for('admin_api.reports_count') }}")
        .then((response) => response.json())
        .then((data) => {
          const newCount = data.count;
          if (newCount > 0) {
            badge.textContent = newCount;
            badge.style.display = "inline-block";
            if (newCount > currentNewReportCount) {
              playNotificationSound();
            }
          } else {
            badge.style.display = "none";
          }
          currentNewReportCount = newCount;
        })
        .catch((error) =>
          console.error("Error checking for new reports:", error)
        );
    };

    // Initialize on page load and then check every 10 seconds
    checkNewReports();
    setInterval(checkNewReports, 10000);

    // One-time event listener to initialize AudioContext on user interaction
    document.body.addEventListener(
      "click",
      () => {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
      },
      { once: true }
    );

    // --- Other page scripts ---
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const rangeBtn = document.getElementById("range-reports-btn");

    if (rangeBtn) {
      rangeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const start = startInput.value;
        const end = endInput.value;
        if (!start || !end) {
          alert("Please select both a start and end date.");
          return;
        }
        window.location.href = `{{ url_for('admin_api.admin_reports_range') }}?start=${start}&end=${end}&scroll=reports`;
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const scrollTo = urlParams.get("scroll");
    if (scrollTo) {
      const element = document.getElementById(
        scrollTo === "qr" ? "qr-result" : "counterfeit-reports"
      );
      if (element) {
        element.scrollIntoView({ behavior: "smooth" });
      }
    }
  });
</script>
{% endblock %}

