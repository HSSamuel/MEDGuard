{% extends "base.html" %} {% block content %}
<style>
  .description-text {
    text-align: justify;
  }
</style>

<div class="panel">
  <h2>{{ _('Public Drug Data Manager') }}</h2>
  <p class="description-text">
    {{ _('View, add, or edit entries in the public drug database. This
    information is shown to users when a scanned drug is not in the main
    MedGuard registry.') }}
  </p>
</div>

<div class="panel">
  <h3>{{ _('Current Public Drug List') }}</h3>
  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch">
    <table class="table">
      <thead>
        <tr>
          <th>{{ _('Batch Number') }}</th>
          <th>{{ _('Drug Name') }}</th>
          <th>{{ _('Manufacturer') }}</th>
          <th>{{ _('Expiry Date') }}</th>
          <th>{{ _('Actions') }}</th>
        </tr>
      </thead>
      <tbody id="public-db-table-body"></tbody>
    </table>
  </div>
  <button id="show-form-btn" class="btn btn-yellow" style="margin-top: 20px">
    âž• {{ _('Add New Drug') }}
  </button>
</div>

<div id="entry-form-panel" class="panel" style="display: none">
  <h3 id="form-title">{{ _('Add New Drug Entry') }}</h3>
  <form id="entry-form">
    <input type="hidden" id="original-batch-key" />

    <div style="margin-bottom: 10px">
      <label style="display: block; margin-bottom: 5px"
        >{{ _('Batch Number (Unique Key):') }}</label
      >
      <input
        type="text"
        id="batch-key"
        class="input"
        style="width: 100%; color: #333"
        required
      />
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: block; margin-bottom: 5px"
        >{{ _('Drug Name:') }}</label
      >
      <input
        type="text"
        id="drug-name"
        class="input"
        style="width: 100%; color: #333"
        required
      />
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: block; margin-bottom: 5px"
        >{{ _('Manufacturer:') }}</label
      >
      <input
        type="text"
        id="manufacturer"
        class="input"
        style="width: 100%; color: #333"
        required
      />
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: block; margin-bottom: 5px"
        >{{ _('NAFDAC Status:') }}</label
      >
      <input
        type="text"
        id="nafdac-status"
        class="input"
        style="width: 100%; color: #333"
        value="Registered"
      />
    </div>
    <div style="margin-bottom: 10px">
      <label style="display: block; margin-bottom: 5px"
        >{{ _('Expiry Date (YYYY-MM-DD):') }}</label
      >
      <input
        type="date"
        id="expiry-date"
        class="input"
        style="width: 100%; color: #333"
        required
      />
    </div>
    <div style="margin-top: 20px">
      <button
        type="submit"
        id="save-entry-btn"
        class="btn"
        style="background-color: #28a745; color: white"
      >
        {{ _('Save Entry') }}
      </button>
      <button type="button" id="cancel-btn" class="btn btn-outline">
        {{ _('Cancel') }}
      </button>
    </div>
  </form>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.getElementById("public-db-table-body");
    const showFormBtn = document.getElementById("show-form-btn");
    const entryFormPanel = document.getElementById("entry-form-panel");
    const entryForm = document.getElementById("entry-form");
    const cancelBtn = document.getElementById("cancel-btn");
    const formTitle = document.getElementById("form-title");

    let publicDb = {};

    const showToast = (message, isError = false) => {
      const toast = document.createElement("div");
      toast.className = "toast-notification";
      if (isError) toast.classList.add("error");
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 100);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    };

    const confirmModal = document.getElementById("confirm-modal");
    const confirmModalTitle = document.getElementById("confirm-modal-title");
    const confirmModalText = document.getElementById("confirm-modal-text");
    const confirmBtn = document.getElementById("confirm-modal-confirm-btn");
    const cancelConfirmBtn = document.getElementById(
      "confirm-modal-cancel-btn"
    );

    const showConfirmModal = (title, text, onConfirm) => {
      if (!confirmModal) return;
      confirmModalTitle.textContent = title;
      confirmModalText.textContent = text;
      confirmModal.style.display = "flex";

      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

      newConfirmBtn.addEventListener("click", () => {
        onConfirm();
        hideConfirmModal();
      });
    };

    const hideConfirmModal = () => {
      if (confirmModal) confirmModal.style.display = "none";
    };

    if (cancelConfirmBtn)
      cancelConfirmBtn.addEventListener("click", hideConfirmModal);

    const renderTable = () => {
      tableBody.innerHTML = "";
      if (Object.keys(publicDb).length === 0) {
        tableBody.innerHTML =
          '<tr><td colspan="5" style="text-align:center;">No entries in the public database.</td></tr>';
        return;
      }
      for (const batchNumber in publicDb) {
        const entry = publicDb[batchNumber];
        const row = tableBody.insertRow();
        row.style.color = "var(--mg-white)";
        row.innerHTML = `
                <td data-label="Batch Number">${batchNumber}</td>
                <td data-label="Drug Name">${entry.drug_name || ""}</td>
                <td data-label="Manufacturer">${entry.manufacturer || ""}</td>
                <td data-label="Expiry Date">${entry.expiry_date || ""}</td>
                <td data-label="Actions">
                    <button class="btn edit-btn" data-batch="${batchNumber}">Edit</button>
                    <button class="btn delete-btn" data-batch="${batchNumber}" style="background-color:#dc3545; color:white;">Delete</button>
                </td>
            `;
      }
      addTableListeners();
    };

    const fetchAndRender = () => {
      fetch("/api/public-db")
        .then((res) => res.json())
        .then((data) => {
          publicDb = data;
          renderTable();
        });
    };

    const showForm = (isEdit = false, batchKey = "") => {
      entryForm.reset();
      document.getElementById("original-batch-key").value = batchKey;
      if (isEdit && publicDb[batchKey]) {
        formTitle.textContent = "Edit Drug Entry";
        document.getElementById("batch-key").value = batchKey;
        document.getElementById("drug-name").value =
          publicDb[batchKey].drug_name;
        document.getElementById("manufacturer").value =
          publicDb[batchKey].manufacturer;
        document.getElementById("nafdac-status").value =
          publicDb[batchKey].nafdac_status;
        document.getElementById("expiry-date").value =
          publicDb[batchKey].expiry_date;
      } else {
        formTitle.textContent = "Add New Drug Entry";
      }
      entryFormPanel.style.display = "block";
      entryFormPanel.scrollIntoView({ behavior: "smooth" });
    };

    const hideForm = () => {
      entryFormPanel.style.display = "none";
    };

    const addTableListeners = () => {
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", (e) =>
          showForm(true, e.target.dataset.batch)
        );
      });
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const batchKey = e.target.dataset.batch;
          showConfirmModal(
            "Confirm Deletion",
            `Are you sure you want to delete the entry for batch "${batchKey}"?`,
            () => {
              delete publicDb[batchKey];
              saveChanges(publicDb);
            }
          );
        });
      });
    };

    const saveChanges = (dbToSave) => {
      fetch("/api/public-db", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dbToSave),
      })
        .then((res) => res.json())
        .then((data) => {
          showToast(data.message, data.status !== "success");
          if (data.status === "success") {
            hideForm();
            fetchAndRender();
          }
        });
    };

    showFormBtn.addEventListener("click", () => showForm(false));
    cancelBtn.addEventListener("click", hideForm);

    entryForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const originalKey = document.getElementById("original-batch-key").value;
      const newKey = document.getElementById("batch-key").value.trim();
      let updatedDb = { ...publicDb };
      if (originalKey && originalKey !== newKey) {
        delete updatedDb[originalKey];
      }
      updatedDb[newKey] = {
        drug_name: document.getElementById("drug-name").value.trim(),
        manufacturer: document.getElementById("manufacturer").value.trim(),
        nafdac_status: document.getElementById("nafdac-status").value.trim(),
        expiry_date: document.getElementById("expiry-date").value.trim(),
      };
      saveChanges(updatedDb);
    });

    fetchAndRender();
  });
</script>
{% endblock %}
